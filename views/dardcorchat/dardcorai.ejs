<% if (chatHistory && chatHistory.length > 0) { %>
    <% chatHistory.forEach(msg => { %>
        <div class="flex w-full <%= msg.role === 'user' ? 'justify-end' : 'justify-start' %> message-bubble-container group min-w-0">
            <div class="flex flex-col <%= msg.role === 'user' ? 'items-end' : 'items-start' %> w-full max-w-full min-w-0">
                
                <% if (msg.file_metadata && msg.file_metadata.length > 0) { %>
                    <div class="flex flex-wrap gap-2 mb-2 <%= msg.role === 'user' ? 'justify-end' : 'justify-start' %> w-full">
                        <% msg.file_metadata.forEach(f => { 
                            const mime = (f.mimetype || '').toLowerCase();
                            const isImage = mime.startsWith('image/');
                            let iconClass = 'fa-file text-gray-400';
                            
                            if (mime.includes('pdf')) iconClass = 'fa-file-pdf text-red-400';
                            else if (mime.includes('word') || mime.includes('document')) iconClass = 'fa-file-word text-blue-400';
                            else if (mime.includes('excel') || mime.includes('sheet') || mime.includes('csv')) iconClass = 'fa-file-excel text-green-400';
                            else if (mime.includes('zip') || mime.includes('compressed')) iconClass = 'fa-file-archive text-yellow-500';
                            else if (mime.includes('code') || f.filename.match(/\.(js|html|css|py|php|java|cpp|json|ejs|ts|sql)$/i)) iconClass = 'fa-file-code text-purple-400';
                        %>
                            <% if (isImage && f.url) { %>
                                <div class="relative rounded-lg overflow-hidden border border-purple-900/30 shadow-lg group transition-transform hover:scale-105 bg-[#0e0e14] min-w-[100px] min-h-[100px] cursor-pointer" onclick="window.open('<%= f.url %>', '_blank')">
                                    <img src="<%= f.url %>" class="max-w-[200px] max-h-[200px] object-cover block">
                                </div>
                            <% } else { %>
                                <div class="text-[10px] flex items-center gap-2 bg-[#0e0e14] px-3 py-1.5 rounded-lg border border-purple-900/30 text-gray-300 max-w-full shadow-sm hover:border-purple-500/50 transition-colors cursor-default" title="<%= f.filename %>">
                                    <i class="fas <%= iconClass %>"></i> <span class="truncate max-w-[150px]"><%= f.filename %></span>
                                </div>
                            <% } %>
                        <% }) %>
                    </div>
                <% } %>

                <% 
                    let processedMessage = msg.message || "";
                    let deepThinkContent = "";
                    let cleanMessage = processedMessage;
                    
                    if (msg.role !== 'user') {
                        const thinkMatch = processedMessage.match(/<think>([\s\S]*?)<\/think>/);
                        if (thinkMatch) {
                            deepThinkContent = thinkMatch[1].trim();
                            cleanMessage = processedMessage.replace(/<think>[\s\S]*?<\/think>/, '').trim();
                        }
                    }
                %>

                <% if (deepThinkContent) { %>
                    <details class="deep-think-box group w-full max-w-full">
                        <summary>
                            <div class="deep-think-header-content">
                                <div class="think-spinner-container">
                                    <img src="/logo.png" class="think-logo-inner">
                                </div>
                                <span class="deep-think-title">Dardcor AI : Show Process</span>
                                <i class="fas fa-chevron-down deep-think-chevron"></i>
                            </div>
                        </summary>
                        <div class="deep-think-content">
                            <div class="whitespace-pre-wrap"><%= deepThinkContent %></div>
                        </div>
                    </details>
                <% } else if (msg.role === 'bot') { %>
                    <div class="bot-identity">
                        <img src="/logo.png" class="bot-identity-logo">
                        <span class="bot-identity-name">Dardcor AI</span>
                    </div>
                <% } %>

                <% if (cleanMessage || msg.role === 'user') { %>
                    <div class="chat-content-box relative rounded-2xl px-5 py-3.5 shadow-md text-sm <%= msg.role === 'user' ? 'bg-transparent border border-purple-600/50 text-white rounded-br-sm shadow-[0_0_15px_rgba(147,51,234,0.15)]' : 'bg-transparent text-gray-200 rounded-bl-sm border-none' %> w-fit min-w-0 max-w-full overflow-hidden leading-7">
                        <% if (msg.role === 'user') { %>
                            <div class="whitespace-pre-wrap break-words user-text"><%= cleanMessage %></div>
                        <% } else { %>
                            <textarea class="hidden raw-message-content"><%= cleanMessage %></textarea>
                            <div class="overflow-guard w-full min-w-0 max-w-full">
                                <div class="markdown-body w-full max-w-full overflow-x-auto break-words"></div>
                            </div>
                        <% } %>
                    </div>
                <% } %>

                <div class="flex items-center gap-3 mt-1 px-1 select-none opacity-50 group-hover:opacity-100 transition-opacity">
                    <button onclick="window.copyMessageBubble(this)" class="text-[10px] font-medium bg-transparent border-none p-0 text-gray-500 hover:text-white flex items-center gap-1.5 transition-colors" title="Salin Pesan">
                        <i class="fas fa-copy"></i> Salin
                    </button>
                    <% if (msg.role !== 'user') { %>
                        <button onclick="window.speakMessage(this)" class="text-[10px] font-medium bg-transparent border-none p-0 text-gray-500 hover:text-white flex items-center gap-1.5 transition-colors" title="Dengarkan Pesan">
                            <i class="fas fa-volume-up"></i> Dengar
                        </button>
                    <% } %>
                    <% if (msg.role === 'user') { %>
                         <button onclick="window.editMessage(this)" class="text-[10px] font-medium bg-transparent border-none p-0 text-gray-500 hover:text-white flex items-center gap-1.5 transition-colors" title="Edit Pesan">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    <% } %>
                </div>

            </div>
        </div>
    <% }) %>
<% } else { %>
    <div id="empty-state" class="flex flex-col items-center justify-center min-h-[50vh] w-full">
        <div class="relative w-48 h-48 md:w-56 md:h-56 flex items-center justify-center mb-6 md:mb-8 perspective-[1000px]">
            <div class="absolute inset-0 bg-purple-900/20 rounded-full blur-3xl animate-pulse"></div>
            <div class="absolute w-[110%] h-[110%] rounded-full border border-purple-500/60 shadow-[0_0_15px_rgba(168,85,247,0.3)] animate-orbit-1 border-t-transparent border-l-transparent"></div>
            <div class="absolute w-[110%] h-[110%] rounded-full border border-fuchsia-500/50 shadow-[0_0_15px_rgba(217,70,239,0.3)] animate-orbit-2 border-b-transparent border-r-transparent"></div>
            <div class="absolute w-[110%] h-[110%] rounded-full border border-violet-500/50 animate-orbit-3 border-t-transparent border-r-transparent"></div>
            <div class="absolute w-[110%] h-[110%] rounded-full border border-indigo-500/40 animate-orbit-4 border-b-transparent border-l-transparent"></div>
            <div class="absolute w-[110%] h-[110%] rounded-full border border-pink-500/40 animate-orbit-5 border-l-transparent border-r-transparent"></div>
            <div class="absolute w-[110%] h-[110%] rounded-full border border-cyan-500/40 animate-orbit-6 border-t-transparent border-b-transparent"></div>

            <div class="w-24 h-24 md:w-28 md:h-28 rounded-full overflow-hidden border-2 border-purple-400/20 bg-[#050508] relative z-10 shadow-[0_0_40px_rgba(147,51,234,0.3)]">
                <div class="absolute inset-0 bg-gradient-to-b from-purple-900/30 via-transparent to-black z-10"></div>
                <img src="/logo.png" alt="Logo" class="relative w-full h-full object-cover opacity-90">
            </div>
        </div>

        <h2 class="text-3xl md:text-5xl font-bold mb-2 text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-200 via-white to-purple-400 drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]">Dardcor AI</h2>
        <p class="text-sm md:text-base text-purple-300/60 text-center max-w-xs md:max-w-md px-4 leading-relaxed font-light tracking-wide">Jelajahi kecerdasan buatan tanpa batas</p>
    </div>
<% } %>