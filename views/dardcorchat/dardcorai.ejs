<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="application-name" content="Dardcor AI">
    
    <title>Dardcor AI</title>
    <link rel="icon" href="/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* Utilities */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        html, body { height: 100%; overflow: hidden; overscroll-behavior: none; background-color: #0b0c15; }
        
        /* Code Block */
        pre { margin: 0; padding: 0; }
        .code-wrapper { margin: 0.5em 0; border-radius: 0.5rem; overflow: hidden; border: 1px solid #374151; background: #111827; }
        .code-header { display: flex; justify-content: space-between; align-items: center; background: #1f2937; padding: 0.5rem 1rem; color: #9ca3af; font-size: 0.75rem; }
        .code-body { padding: 1rem; overflow-x: auto; color: #e5e7eb; font-family: monospace; font-size: 0.875rem; }

        /* Markdown */
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body h1, .markdown-body h2 { color: #f3f4f6; font-weight: 700; margin-top: 1em; }
        .markdown-body ul { list-style: disc; margin-left: 1.5em; }
        .markdown-body a { color: #a78bfa; text-decoration: underline; }

        /* Sidebar Animations */
        #sidebar { transition: width 0.3s ease, transform 0.3s ease; }
        
        /* Mobile Overlay */
        #mobile-overlay { transition: opacity 0.3s ease; }

        /* Typing Dot Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Z-Index Management untuk memastikan tombol bisa diklik */
        .z-modal { z-index: 60; }
        .z-sidebar { z-index: 50; }
        .z-overlay { z-index: 40; }
        .z-header { z-index: 30; }
        .z-content { z-index: 10; }
    </style>
</head>
<body class="text-white font-sans h-screen flex relative" id="body-drop-zone">

    <div id="drag-overlay" class="fixed inset-0 bg-purple-500/20 backdrop-blur-sm z-[70] opacity-0 invisible flex flex-col items-center justify-center border-4 border-purple-500 border-dashed m-4 rounded-xl pointer-events-none transition-all">
        <i class="fas fa-cloud-upload-alt text-6xl text-purple-400 mb-4 animate-bounce"></i>
        <h2 class="text-2xl font-bold text-white">Lepaskan file disini</h2>
    </div>

    <div id="rename-modal" class="fixed inset-0 z-modal hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-[#13131f] border border-purple-900/50 rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-1">Ganti Nama</h3>
            <input type="text" id="rename-input" class="w-full bg-[#0b0c15] border border-gray-600 rounded-lg px-4 py-3 mt-4 text-white focus:border-purple-500 outline-none" autocomplete="off">
            <div class="flex justify-end gap-3 mt-6">
                 <button onclick="closeModal('rename-modal')" class="px-5 py-2 text-sm text-gray-300 hover:text-white">Batal</button>
                <button onclick="submitRename()" class="px-5 py-2 text-sm bg-violet-600 hover:bg-violet-500 text-white rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 z-modal hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-[#13131f] border border-purple-900/50 rounded-2xl w-full max-w-sm p-6 shadow-2xl text-center">
            <div class="w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20"><i class="fas fa-trash-alt text-red-500"></i></div>
            <h3 class="text-lg font-bold text-white">Hapus Percakapan?</h3>
            <p class="text-gray-400 text-sm mt-2">Data tidak bisa dikembalikan.</p>
            <div class="flex justify-center gap-3 mt-6">
                <button onclick="closeModal('delete-modal')" class="px-5 py-2 text-sm bg-gray-800 text-gray-300 rounded-lg w-full">Batal</button>
                <button onclick="submitDelete()" class="px-5 py-2 text-sm bg-red-600 text-white rounded-lg w-full">Hapus</button>
            </div>
        </div>
    </div>

    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-overlay hidden md:hidden backdrop-blur-sm"></div>

    <aside id="sidebar" class="bg-[#13131f] border-r border-purple-900/30 flex flex-col shrink-0 h-full
               fixed inset-y-0 left-0 z-sidebar transform -translate-x-full w-72 
               md:relative md:translate-x-0 md:w-72 shadow-2xl md:shadow-none overflow-hidden">
        
        <div class="p-4 flex items-center justify-between border-b border-purple-900/30 h-16 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full overflow-hidden border border-purple-500/50">
                    <img src="/logo.png" alt="Logo" class="w-full h-full object-cover">
                </div>
                <span class="font-bold text-lg tracking-wider text-purple-500">Dardcor</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white p-2"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-3 shrink-0">
            <button onclick="createNewChat()" class="w-full flex items-center gap-3 p-3 rounded-xl border border-dashed border-gray-600 hover:border-purple-500 hover:bg-purple-900/20 text-left transition-all group">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center text-gray-400 group-hover:text-purple-400 group-hover:bg-purple-900/30 transition"><i class="fas fa-plus text-xs"></i></div>
                <span class="text-sm font-medium text-gray-300 group-hover:text-white">New Chat</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-3 space-y-1 scrollbar-hide">
            <div class="px-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2 mt-2">Riwayat</div>

            <% const currentChatExists = fullHistory.some(chat => chat.conversation_id === activeConversationId); %>
            <% if (!currentChatExists) { %>
                <div class="flex items-center px-3 py-3 rounded-xl bg-[#202336] border border-purple-500/40 cursor-default mb-2">
                    <i class="fas fa-comment-dots text-purple-400 mr-3 text-xs"></i>
                    <span class="text-sm text-white font-medium truncate">Percakapan Baru...</span>
                </div>
            <% } %>

            <% fullHistory.forEach(chat => { %>
                <div class="group relative flex items-center rounded-xl hover:bg-[#1e2030] transition cursor-pointer <%= chat.conversation_id === activeConversationId ? 'bg-[#202336] border border-purple-500/20' : 'border border-transparent' %>">
                    <a href="/dardcorchat/dardcor-ai/<%= chat.conversation_id %>" class="flex-1 flex items-center px-3 py-3 min-w-0">
                        <i class="fas fa-message mr-3 text-xs shrink-0 <%= chat.conversation_id === activeConversationId ? 'text-purple-400' : 'text-gray-600' %>"></i>
                        <span class="text-sm truncate <%= chat.conversation_id === activeConversationId ? 'text-white' : 'text-gray-400' %>"><%= chat.message ? chat.message.substring(0, 25) : 'Percakapan' %>...</span>
                    </a>
                    
                    <div class="relative px-2">
                        <button onclick="toggleMenu(event, 'menu-<%= chat.conversation_id %>')" class="p-1.5 text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 focus:opacity-100 transition">
                            <i class="fas fa-ellipsis-v text-xs"></i>
                        </button>
                        <div id="menu-<%= chat.conversation_id %>" class="dropdown-menu hidden absolute right-0 top-8 w-32 bg-[#2a2d3d] border border-gray-700 rounded-xl shadow-2xl z-50 py-1 overflow-hidden">
                            <button onclick="openRenameModal('<%= chat.conversation_id %>', this.getAttribute('data-title')); event.preventDefault();" data-title="<%= chat.message %>" class="w-full text-left px-3 py-2 text-xs text-gray-300 hover:bg-purple-600 hover:text-white flex items-center gap-2"><i class="fas fa-pen"></i> Rename</button>
                            <button onclick="openDeleteModal('<%= chat.conversation_id %>'); event.preventDefault();" class="w-full text-left px-3 py-2 text-xs text-red-400 hover:bg-red-600 hover:text-white flex items-center gap-2"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>

        <div class="p-4 border-t border-purple-900/30 bg-[#0e0f19] flex items-center shrink-0">
            <a href="/dardcorchat/profile" class="flex items-center flex-1 min-w-0 gap-3 group">
                <div class="w-9 h-9 rounded-full overflow-hidden border border-gray-600 group-hover:border-purple-500">
                    <img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + user.username %>" class="w-full h-full object-cover">
                </div>
                <div class="flex flex-col overflow-hidden">
                    <span class="text-sm font-medium text-gray-200 truncate group-hover:text-purple-400"><%= user.username %></span>
                    <span class="text-[10px] text-gray-500">Free Plan</span>
                </div>
            </a>
            <a href="/dardcor-logout" class="text-gray-500 hover:text-red-400 p-2"><i class="fas fa-sign-out-alt"></i></a>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative min-w-0 bg-[#0b0c15] z-content">
        
        <header class="h-16 flex items-center justify-between px-4 border-b border-purple-900/30 bg-[#0b0c15]/95 backdrop-blur z-header sticky top-0 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <span class="md:hidden font-bold text-purple-500">Dardcor AI</span>
            </div>
            <div class="hidden md:flex text-gray-500 text-xs px-3 py-1 bg-[#13131f] rounded-full border border-gray-800"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Dardcor-V2 Model</div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto w-full scrollbar-hide pt-4 pb-2 px-2 md:px-0">
            <div id="message-list" class="max-w-3xl mx-auto px-2 md:px-6 space-y-6 pb-4">
                
                <% if (chatHistory.length === 0) { %>
                    <div id="empty-state" class="flex flex-col items-center justify-center min-h-[50vh] opacity-80">
                        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-purple-900/20 to-blue-900/20 flex items-center justify-center mb-6 border border-purple-500/20 overflow-hidden">
                            <img src="/logo.png" alt="Logo" class="w-full h-full object-cover opacity-80">
                        </div>
                        <h2 class="text-xl font-bold text-white mb-2">Apa yang bisa saya bantu?</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6 w-full max-w-lg px-4">
                            <button onclick="fillInput('Buatkan kode HTML Login Page')" class="p-3 bg-[#13131f] border border-gray-800 rounded-xl text-xs text-left text-gray-300 hover:border-purple-500/50 hover:bg-[#1a1a2e] transition"><i class="fas fa-code text-purple-400 mr-2"></i> Buat Kode HTML</button>
                            <button onclick="fillInput('Ide konten TikTok viral')" class="p-3 bg-[#13131f] border border-gray-800 rounded-xl text-xs text-left text-gray-300 hover:border-purple-500/50 hover:bg-[#1a1a2e] transition"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i> Ide Konten</button>
                        </div>
                    </div>
                <% } else { %>
                    <% chatHistory.forEach(msg => { %>
                        <div class="flex w-full <%= msg.role === 'user' ? 'justify-end' : 'justify-start' %> animate-[fadeIn_0.3s_ease-out]">
                            <div class="flex flex-col <%= msg.role === 'user' ? 'items-end' : 'items-start' %> message-bubble">
                                <div class="flex items-center gap-2 mb-1.5 px-1 opacity-80">
                                    <% if (msg.role === 'bot') { %>
                                        <div class="w-6 h-6 rounded-full overflow-hidden border border-purple-500/50"><img src="/logo.png" class="w-full h-full object-cover"></div>
                                        <span class="text-[10px] font-bold text-purple-400">Dardcor AI</span>
                                    <% } else { %>
                                        <span class="text-[10px] font-bold text-gray-400">You</span>
                                        <div class="w-6 h-6 rounded-full overflow-hidden border border-gray-600"><img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + user.username %>" class="w-full h-full object-cover"></div>
                                    <% } %>
                                </div>
                                <div class="rounded-2xl p-4 shadow-lg text-sm leading-relaxed overflow-hidden w-full <%= msg.role === 'user' ? 'bg-gradient-to-br from-violet-600 to-fuchsia-700 text-white rounded-tr-none' : 'bg-[#1e2030] text-gray-200 rounded-tl-none border border-gray-700/50' %>">
                                    <% if (msg.file_metadata) { %>
                                        <div class="mb-3 text-xs flex items-center gap-3 bg-black/20 p-2.5 rounded-xl border border-white/10">
                                            <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center"><i class="fas fa-file"></i></div>
                                            <div class="flex flex-col overflow-hidden min-w-0">
                                                <span class="truncate font-medium text-white"><%= msg.file_metadata.filename %></span>
                                                <span class="opacity-70 text-[10px]"><%= Math.round(msg.file_metadata.size / 1024) %> KB</span>
                                            </div>
                                        </div>
                                     <% } %>
                                    <div class="markdown-body" data-role="<%= msg.role %>"><%= msg.message %></div>
                                </div>
                             </div>
                        </div>
                    <% }) %>
                <% } %>
                
                <div id="loading-indicator" class="hidden flex w-full justify-start">
                    <div class="flex flex-col items-start message-bubble">
                        <div class="flex items-center gap-2 mb-1.5 px-1">
                            <div class="w-6 h-6 rounded-full overflow-hidden border border-purple-500/50"><img src="/logo.png" class="w-full h-full object-cover"></div>
                            <span class="text-[10px] font-bold text-purple-400">Thinking...</span>
                        </div>
                        <div class="bg-[#1e2030] px-4 py-3 rounded-2xl rounded-tl-none border border-gray-700/50 flex items-center gap-1.5 shadow-md">
                            <div class="w-2 h-2 bg-purple-500 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="shrink-0 w-full z-30 bg-[#0b0c15] border-t border-purple-900/20 p-3 md:p-5">
            <div class="max-w-3xl mx-auto w-full relative group">
                <div id="file-preview" class="hidden absolute -top-12 left-0 right-0 mx-2 bg-[#1a1a2e] border border-purple-500/30 rounded-t-xl p-2 flex items-center justify-between shadow-lg">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-6 h-6 bg-purple-500/20 rounded flex items-center justify-center text-purple-400 shrink-0"><i class="fas fa-file"></i></div>
                        <span id="file-name-text" class="text-xs text-gray-300 truncate">file.txt</span>
                    </div>
                    <button onclick="clearFile()" class="text-gray-500 hover:text-red-400"><i class="fas fa-times"></i></button>
                </div>

                <form id="chat-form" onsubmit="return false;" class="bg-[#13131f] border border-gray-700 rounded-2xl flex items-end shadow-2xl p-1.5 focus-within:border-purple-500 transition-all">
                    <label for="file-upload" class="p-3 text-gray-400 hover:text-white cursor-pointer rounded-xl hover:bg-gray-800 shrink-0">
                        <i class="fas fa-paperclip text-lg"></i>
                        <input type="file" id="file-upload" name="file_attachment" class="hidden">
                     </label>
                    <div class="flex-1 min-w-0 py-2 px-1">
                        <textarea id="message-input" name="message" rows="1" class="w-full bg-transparent border-none outline-none text-white resize-none max-h-40 placeholder-gray-500 text-sm scrollbar-hide" placeholder="Kirim pesan..."></textarea>
                    </div>
                    <button type="button" onclick="sendMessage()" id="send-btn" class="p-3 bg-white text-black hover:bg-gray-200 rounded-xl shrink-0"><i class="fas fa-arrow-up text-lg"></i></button>
                </form>
                <p class="text-center text-[10px] text-gray-600 mt-2">Dardcor AI dapat membuat kesalahan.</p>
            </div>
        </div>
    </main>

    <script>
        // --- ELEMENTS ---
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');
        const chatContainer = document.getElementById('chat-container');
        const messageList = document.getElementById('message-list');
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-upload');
        const filePreview = document.getElementById('file-preview');
        const fileNameText = document.getElementById('file-name-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const emptyState = document.getElementById('empty-state');
        
        let currentConversationId = "<%= activeConversationId %>";
        let targetChatId = null;
        let isSending = false;
        let isSidebarOpenDesktop = true; // State default desktop

        // --- SIDEBAR LOGIC (THE FIX) ---
        function toggleSidebar() {
            if (window.innerWidth < 768) {
                // MOBILE MODE: Menggunakan translate-x untuk slide
                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            } else {
                // DESKTOP MODE: Mengubah Width
                // Kita gunakan class 'w-0' dan 'p-0' untuk menutup sidebar di desktop
                if (isSidebarOpenDesktop) {
                    sidebar.classList.remove('md:w-72');
                    sidebar.style.width = '0px';
                    sidebar.style.padding = '0px'; // Hilangkan padding agar teks tidak bocor
                    isSidebarOpenDesktop = false;
                } else {
                    sidebar.classList.add('md:w-72');
                    sidebar.style.width = ''; // Reset ke stylesheet (w-72)
                    sidebar.style.padding = ''; 
                    isSidebarOpenDesktop = true;
                }
            }
        }

        // Reset Sidebar saat Resize Layar
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                // Jika pindah ke Desktop, reset tampilan mobile
                sidebar.classList.add('-translate-x-full'); 
                overlay.classList.add('hidden');
                
                // Kembalikan status desktop terakhir
                if(isSidebarOpenDesktop) {
                    sidebar.classList.add('md:w-72');
                    sidebar.style.width = '';
                } else {
                    sidebar.classList.remove('md:w-72');
                    sidebar.style.width = '0px';
                }
            }
        });

        // --- INPUT & CHAT LOGIC ---
        function fillInput(text) {
            messageInput.value = text;
            messageInput.focus();
            autoResizeInput();
        }

        messageInput.addEventListener('input', autoResizeInput);
        function autoResizeInput() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
        }

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if(window.innerWidth < 768 && this.value.trim() === "") return; // Cegah enter accidental di mobile
                sendMessage();
            }
        });

        // --- FILE HANDLING ---
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameText.textContent = fileInput.files[0].name;
                filePreview.classList.remove('hidden');
            } else {
                filePreview.classList.add('hidden');
            }
        });

        function clearFile() {
            fileInput.value = '';
            filePreview.classList.add('hidden');
        }

        // --- SEND MESSAGE ---
        async function sendMessage() {
            if (isSending) return;
            const message = messageInput.value.trim();
            const file = fileInput.files[0];

            if (!message && !file) return;
            
            isSending = true;
            const currentMessage = message;
            
            // UI Updates
            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearFile();
            if(emptyState) emptyState.style.display = 'none';
            
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50');

            // Show User Message
            appendUserMessage(currentMessage, file ? file.name : null, file ? file.size : 0);
            loadingIndicator.classList.remove('hidden');
            scrollToBottom();

            const formData = new FormData();
            formData.append('message', currentMessage);
            formData.append('conversationId', currentConversationId);
            if (file) formData.append('file_attachment', file);

            try {
                const res = await fetch('/dardcorchat/ai/chat', { method: 'POST', body: formData });
                const data = await res.json();
                loadingIndicator.classList.add('hidden');

                if (data.success) {
                    typeBotMessage(data.response);
                } else {
                    appendErrorMessage(data.response || "Error dari server.");
                }
            } catch (err) {
                loadingIndicator.classList.add('hidden');
                appendErrorMessage("Gagal terhubung ke server.");
            } finally {
                isSending = false;
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50');
                messageInput.focus();
            }
        }

        // --- RENDER MESSAGES ---
        function appendUserMessage(text, fileName, fileSize) {
            const div = document.createElement('div');
            div.className = "flex w-full justify-end animate-[fadeIn_0.3s_ease-out]";
            let fileHTML = '';
            if(fileName) {
                const sizeKB = Math.round(fileSize / 1024);
                fileHTML = `<div class="mb-2 text-xs flex items-center gap-3 bg-black/20 p-2 rounded border border-white/10"><i class="fas fa-file"></i> <span>${fileName} (${sizeKB}KB)</span></div>`;
            }
            div.innerHTML = `
            <div class="flex flex-col items-end message-bubble">
                <div class="bg-gradient-to-br from-violet-600 to-fuchsia-700 text-white rounded-2xl rounded-tr-none p-4 shadow-lg text-sm leading-relaxed w-full">
                    ${fileHTML}
                    <div class="whitespace-pre-wrap">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                </div>
            </div>`;
            messageList.insertBefore(div, loadingIndicator);
            scrollToBottom();
        }

        function typeBotMessage(rawText) {
            const div = document.createElement('div');
            div.className = "flex w-full justify-start";
            div.innerHTML = `
                <div class="flex flex-col items-start message-bubble">
                    <div class="flex items-center gap-2 mb-1 opacity-80"><div class="w-5 h-5 rounded-full overflow-hidden"><img src="/logo.png" class="w-full h-full object-cover"></div> <span class="text-[10px] font-bold text-purple-400">Dardcor AI</span></div>
                    <div class="bg-[#1e2030] text-gray-200 rounded-2xl rounded-tl-none p-4 shadow-lg text-sm leading-relaxed border border-gray-700/50 w-full">
                        <div class="markdown-body typing-target"></div>
                    </div>
                </div>`;
            messageList.insertBefore(div, loadingIndicator);
            
            const target = div.querySelector('.typing-target');
            let index = 0;
            const speed = 5; 
            const chunk = 5; 
            
            const interval = setInterval(() => {
                index += chunk;
                if (index > rawText.length) index = rawText.length;
                target.innerHTML = marked.parse(rawText.substring(0, index));
                enhanceCodeBlocks(target);
                scrollToBottom();
                if (index >= rawText.length) clearInterval(interval);
            }, speed);
        }

        function appendErrorMessage(text) {
             const div = document.createElement('div');
             div.className = "flex justify-center my-4";
             div.innerHTML = `<div class="text-red-400 text-xs bg-red-500/10 px-3 py-1 rounded border border-red-500/20">${text}</div>`;
             messageList.insertBefore(div, loadingIndicator);
             scrollToBottom();
        }

        function scrollToBottom() {
            setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
        }

        // --- UTILS (MODALS & MENU) ---
        function toggleMenu(e, menuId) {
            e.preventDefault(); e.stopPropagation();
            document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById(menuId).classList.toggle('hidden');
        }
        document.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.add('hidden')));

        function openRenameModal(id, title) {
            targetChatId = id;
            document.getElementById('rename-input').value = title;
            document.getElementById('rename-modal').classList.remove('hidden');
            document.getElementById('rename-modal').classList.add('flex');
        }
        function openDeleteModal(id) {
            targetChatId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('delete-modal').classList.add('flex');
        }
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        async function createNewChat() {
            const res = await fetch('/dardcorchat/ai/new-chat', { method: 'POST' });
            const data = await res.json();
            if(data.success) window.location.href = data.redirectUrl;
        }

        async function submitRename() {
            const val = document.getElementById('rename-input').value;
            if(!val) return;
            await fetch('/dardcorchat/ai/rename-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ conversationId: targetChatId, newTitle: val })
            });
            window.location.reload();
        }

        async function submitDelete() {
            await fetch('/dardcorchat/ai/delete-chat-history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ conversationId: targetChatId })
            });
            window.location.href = '/dardcorchat/dardcor-ai';
        }

        function enhanceCodeBlocks(ctx = document) {
            ctx.querySelectorAll('pre code').forEach((block) => {
                if (block.closest('.code-wrapper')) return;
                hljs.highlightElement(block);
                const pre = block.parentElement;
                const wrapper = document.createElement('div'); wrapper.className = 'code-wrapper';
                const header = document.createElement('div'); header.className = 'code-header';
                header.innerHTML = `<span>${(block.className.replace('language-', '') || 'CODE').toUpperCase()}</span><button class="text-xs hover:text-white" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)">Copy</button>`;
                const body = document.createElement('div'); body.className = 'code-body';
                
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(header);
                wrapper.appendChild(body);
                body.appendChild(pre);
            });
        }
        
        // Init Markdown & Highlight
        document.querySelectorAll('.markdown-body').forEach(el => {
            if(el.dataset.role === 'bot') {
                el.innerHTML = marked.parse(el.textContent);
                enhanceCodeBlocks(el);
            }
        });
        scrollToBottom();
    </script>
</body>
</html>