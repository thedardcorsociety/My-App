<% if (chatHistory && chatHistory.length > 0) { %>
    <div id="message-list" class="w-full flex flex-col gap-6 mt-auto pb-4">
        <% chatHistory.forEach(msg => { %>
            <div class="flex w-full <%= msg.role === 'user' ? 'justify-end' : 'justify-start' %> message-bubble-container group min-w-0">
                <div class="flex flex-col <%= msg.role === 'user' ? 'items-end' : 'items-start' %> max-w-[92%] md:max-w-[82%] min-w-0">
                    
                    <% if (msg.file_metadata && msg.file_metadata.length > 0) { %>
                        <div class="flex flex-wrap gap-2 mb-2 <%= msg.role === 'user' ? 'justify-end' : 'justify-start' %> w-full">
                            <% msg.file_metadata.forEach(f => { %>
                                <div class="text-[10px] flex items-center gap-2 bg-[#1c1c2e] px-3 py-1.5 rounded-lg border border-white/10 text-gray-300 max-w-full shadow-sm">
                                    <i class="fas fa-file text-purple-400"></i> <span class="truncate"><%= f.filename %></span>
                                </div>
                            <% }) %>
                        </div>
                    <% } %>

                    <div class="chat-content-box relative rounded-2xl px-5 py-3.5 shadow-md text-sm <%= msg.role === 'user' ? 'bg-purple-600 text-white rounded-br-sm' : 'bg-[#1e1e2e] text-gray-200 rounded-bl-sm border border-white/5' %> w-fit min-w-0 max-w-full overflow-hidden leading-7">
                        <% if (msg.role === 'user') { %>
                            <div class="whitespace-pre-wrap break-words user-text"><%= msg.message %></div>
                        <% } else { %>
                            <textarea class="hidden raw-message-content"><%= msg.message %></textarea>
                            <div class="markdown-body w-full max-w-full overflow-x-auto break-words"></div>
                        <% } %>
                    </div>

                    <div class="flex items-center gap-2 mt-2 px-1 select-none">
                        <button onclick="copyMessageBubble(this)" class="text-gray-500 hover:text-white transition-colors flex items-center gap-1.5 bg-[#1c1c2e] border border-white/5 px-3 py-1.5 rounded-lg hover:bg-white/10 shadow-sm group active:scale-95" title="Salin">
                            <i class="fas fa-copy text-xs"></i> <span class="text-[10px] font-medium">Salin</span>
                        </button>
                        <% if (msg.role !== 'user') { %>
                            <button onclick="speakMessage(this)" class="text-gray-500 hover:text-white transition-colors flex items-center gap-1.5 bg-[#1c1c2e] border border-white/5 px-3 py-1.5 rounded-lg hover:bg-white/10 shadow-sm group active:scale-95" title="Dengarkan">
                                <i class="fas fa-volume-up text-xs"></i> <span class="text-[10px] font-medium">Dengar</span>
                            </button>
                        <% } %>
                    </div>

                </div>
            </div>
        <% }) %>
    </div>
<% } else { %>
    <div id="message-list" class="w-full h-full flex flex-col items-center justify-center pointer-events-none pb-4"></div>
<% } %>